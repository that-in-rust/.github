#!/usr/bin/env bash
set -euo pipefail

# Configure base directory (Desktop/PensieveDB01)
DESKTOP_DIR="${HOME}/Desktop"
TARGET_DIR="${DESKTOP_DIR}/PensieveDB01"

mkdir -p "${TARGET_DIR}"
echo "Saving into: ${TARGET_DIR}"

# 1) Save your write-up as README
cat > "${TARGET_DIR}/README.txt" <<'EOF'
Title: Finding and Studying High‑Quality Pre‑2010 Codebases

Why great pre‑2010 code isn’t obvious on GitHub
-   Many seminal projects lived on CVS/SVN/Mercurial/Bazaar and non‑GitHub forges (SourceForge, Savannah, kernel.org, Apache SVN, Mozilla hg, Launchpad).
-   GitHub mirrors often start late, or were imported without full history.
-   Canonical repos and historical tarballs often remain on project‑specific hosts or archives.

Where to find high‑quality pre‑2010 code (canonical hosts and archives)
-   Software Heritage: Universal archive of VCS history across the web. Browse by project; export snapshots. (Linux, GCC, CPython, etc.)
-   SourceForge: 1999‑era projects; file releases; CVS/SVN. Check “Files” and “Code”. (Nmap, GIMP old, TuxPaint, SciPy early)
-   Google Code Archive: 2006–2015 read‑only. Web browse, download snapshots. (Early protobuf, Go tools)
-   GNU Savannah: GNU and non‑GNU; CVS/SVN/Git. (Emacs, Bash, Coreutils, Make, GDB)
-   kernel.org: Canonical Linux and related. (Linux kernel, e2fsprogs, kmod)
-   Apache (SVN/Git): Long SVN histories; Git mirrors. (httpd, Subversion, Ant, Lucene)
-   Mozilla (Mercurial): Full Gecko/Firefox history. (mozilla‑central)
-   BSDs (CVS/SVN/Git): Decades of OS code. (FreeBSD src, OpenBSD src incl. OpenSSH, NetBSD)
-   Launchpad (Bazaar): Bazaar repos. (Ubuntu packages, Inkscape pre‑Git)
-   Sourceware: Toolchain fundamentals. (glibc, binutils, GDB, newlib)
-   freedesktop.org: Graphics/display stack. (Mesa, Cairo, Wayland, X.Org)
-   SQLite (Fossil): Full history since ~2000. (SQLite)
-   Debian snapshot: Historical source packages. (tarballs + distro patches)
-   CPAN / MetaCPAN: Perl ecosystem history (tarballs; VCS links).

Exemplary pre‑2010 codebases to study (and why)
-   Linux kernel — architecture, concurrency, subsystems, review culture.
-   GCC + binutils + glibc — compilers, linkers, libc internals.
-   CPython — interpreter, object model, stdlib design.
-   PostgreSQL — clean C, MVCC internals, reliability.
-   SQLite — small, rigorous tests, clever engineering.
-   OpenBSD src (incl. OpenSSH) — clarity, security‑first engineering.
-   Apache httpd — modular server, APR, config system.
-   Nginx — event‑driven networking, master/worker model.
-   FFmpeg — performance‑critical C, codecs, DSP.
-   Git — content‑addressed storage, VCS algorithms.
-   Emacs and Vim — editor architectures, extension systems.
-   WebKit and Mozilla — large browser engines and build systems.

Practical ways to pull historical snapshots
(see vcs-commands/ below for canonical VCS commands; no GitHub/GitLab needed)
EOF

# Helper: curl with sensible defaults
curl_dl () {
    local url="$1"
    local out="$2"
    echo "Downloading: ${url}"
    curl -fL --retry 3 --retry-delay 2 --connect-timeout 15 --max-time 900 -o "${out}" "${url}"
}

# 2) Create subfolders
mkdir -p "${TARGET_DIR}/landing-pages"
mkdir -p "${TARGET_DIR}/archives"
mkdir -p "${TARGET_DIR}/vcs-commands"

# 3) Canonical landing pages (HTML bookmarks)
curl_dl "https://www.softwareheritage.org/"        "${TARGET_DIR}/landing-pages/software-heritage.html"
curl_dl "https://sourceforge.net/"                  "${TARGET_DIR}/landing-pages/sourceforge.html"
curl_dl "https://code.google.com/archive/"          "${TARGET_DIR}/landing-pages/google-code-archive.html"
curl_dl "https://savannah.gnu.org/"                 "${TARGET_DIR}/landing-pages/gnu-savannah.html"
curl_dl "https://kernel.org/"                       "${TARGET_DIR}/landing-pages/kernel-org.html"
curl_dl "https://httpd.apache.org/"                 "${TARGET_DIR}/landing-pages/apache-httpd.html"
curl_dl "https://svn.apache.org/repos/asf/"         "${TARGET_DIR}/landing-pages/apache-svn-root.html"
curl_dl "https://hg.mozilla.org/"                   "${TARGET_DIR}/landing-pages/mozilla-hg.html"
curl_dl "https://cgit.freebsd.org/src/"             "${TARGET_DIR}/landing-pages/freebsd-src.html"
curl_dl "https://cvsweb.openbsd.org/"               "${TARGET_DIR}/landing-pages/openbsd-cvsweb.html"
curl_dl "https://anonhg.NetBSD.org/"                "${TARGET_DIR}/landing-pages/netbsd-hg.html"
curl_dl "https://launchpad.net/"                    "${TARGET_DIR}/landing-pages/launchpad.html"
curl_dl "https://sourceware.org/"                   "${TARGET_DIR}/landing-pages/sourceware.html"
curl_dl "https://www.freedesktop.org/wiki/"         "${TARGET_DIR}/landing-pages/freedesktop.html"
curl_dl "https://www.sqlite.org/src"                "${TARGET_DIR}/landing-pages/sqlite-fossil.html"
curl_dl "https://snapshot.debian.org/"              "${TARGET_DIR}/landing-pages/debian-snapshot.html"
curl_dl "https://metacpan.org/"                     "${TARGET_DIR}/landing-pages/metacpan.html"

# 4) Exemplary pre-2010 release tarballs from official sites
# Note: sizes vary; adjust versions if you need different points-in-time.

# Linux kernel 2.6.32 (2009-12)
curl_dl "https://www.kernel.org/pub/linux/kernel/v2.6/linux-2.6.32.tar.xz" \
        "${TARGET_DIR}/archives/linux-2.6.32.tar.xz"

# GCC 4.4.0 (2009-04)
curl_dl "https://ftp.gnu.org/gnu/gcc/gcc-4.4.0/gcc-4.4.0.tar.bz2" \
        "${TARGET_DIR}/archives/gcc-4.4.0.tar.bz2"

# binutils 2.20 (2009-10)
curl_dl "https://ftp.gnu.org/gnu/binutils/binutils-2.20.tar.bz2" \
        "${TARGET_DIR}/archives/binutils-2.20.tar.bz2"

# glibc 2.10.1 (2009-07)
curl_dl "https://ftp.gnu.org/gnu/libc/glibc-2.10.1.tar.bz2" \
        "${TARGET_DIR}/archives/glibc-2.10.1.tar.bz2"

# CPython 2.6.4 (2009-10)
curl_dl "https://www.python.org/ftp/python/2.6.4/Python-2.6.4.tgz" \
        "${TARGET_DIR}/archives/Python-2.6.4.tgz"

# PostgreSQL 8.4.0 (2009-07)
curl_dl "https://ftp.postgresql.org/pub/source/v8.4.0/postgresql-8.4.0.tar.bz2" \
        "${TARGET_DIR}/archives/postgresql-8.4.0.tar.bz2"

# SQLite 3.6.22 (2009-12) amalgamation
curl_dl "https://www.sqlite.org/2009/sqlite-amalgamation-3.6.22.tar.gz" \
        "${TARGET_DIR}/archives/sqlite-amalgamation-3.6.22.tar.gz"

# OpenBSD source snapshots are browsed via CVSWeb; release tar sets:
curl_dl "https://cdn.openbsd.org/pub/OpenBSD/5.7/src.tar.gz" \
        "${TARGET_DIR}/archives/openbsd-src-5.7.tar.gz" || true
# Note: This is post-2010; for true pre-2010, fetch specific component tarballs from older releases via mirrors or use CVS. See vcs-commands README.

# Apache httpd 2.2.0 (2005-12)
curl_dl "https://archive.apache.org/dist/httpd/httpd-2.2.0.tar.bz2" \
        "${TARGET_DIR}/archives/httpd-2.2.0.tar.bz2"

# Nginx 0.8.54 (2010-09)
curl_dl "http://nginx.org/download/nginx-0.8.54.tar.gz" \
        "${TARGET_DIR}/archives/nginx-0.8.54.tar.gz"

# FFmpeg 0.5 (2009-03)
curl_dl "https://ffmpeg.org/releases/ffmpeg-0.5.tar.bz2" \
        "${TARGET_DIR}/archives/ffmpeg-0.5.tar.bz2"

# Git 1.6.6 (2009-12) from kernel.org
curl_dl "https://www.kernel.org/pub/software/scm/git/git-1.6.6.tar.gz" \
        "${TARGET_DIR}/archives/git-1.6.6.tar.gz"

# Emacs 23.1 (2009-07)
curl_dl "https://ftp.gnu.org/gnu/emacs/emacs-23.1.tar.gz" \
        "${TARGET_DIR}/archives/emacs-23.1.tar.gz"

# Vim 7.2 (2008-08)
curl_dl "https://ftp.vim.org/pub/vim/unix/vim-7.2.tar.bz2" \
        "${TARGET_DIR}/archives/vim-7.2.tar.bz2"

# WebKit and Mozilla are primarily VCS-based; see vcs-commands below.

# 5) Canonical VCS commands (not executed; saved for you to run manually)
cat > "${TARGET_DIR}/vcs-commands/README-canonical-VCS.txt" <<'EOF'
Canonical VCS commands for pre-2010 history (no GitHub/GitLab).

Apache httpd (Subversion; tag 2.2.0 as example):
  svn checkout https://svn.apache.org/repos/asf/httpd/httpd/tags/2.2.0 httpd-2.2.0

Mozilla (Mercurial; mozilla-central full history):
  hg clone https://hg.mozilla.org/mozilla-central mozilla-central
  cd mozilla-central
  hg log -d "date(<2010)"
  # Checkout the last changeset before 2010:
  hg up -r "$(hg log -d 'date(<2010)' -l 1 --template '{node}\n')"

Nginx (Mercurial pre-Git era mirrors existed; modern canonical is hg.git mirror and tarballs):
  # Prefer official tarballs for 2009–2010:
  # http://nginx.org/download/nginx-0.8.54.tar.gz (2010)
  # For older exact dates, use vendor source archives or distribution snapshots.

SQLite (Fossil):
  fossil clone https://www.sqlite.org/src sqlite.fossil
  mkdir sqlite-checkout && cd sqlite-checkout
  fossil open ../sqlite.fossil
  fossil timeline before 2010
  # Checkout the last check-in before 2010:
  fossil update $(fossil timeline before 2010 -n 1 --type ci --width 0 | awk 'NR==2{print $1}')

BSDs:
  OpenBSD CVSWeb (browse and fetch diffs/files):
    https://cvsweb.openbsd.org/
  FreeBSD (git now; historical CVS/SVN via mirrors; for pre-2010, consult release tarballs or CVSweb mirrors):
    https://cgit.freebsd.org/src/
  NetBSD Mercurial mirrors (anonhg) and CVS:
    https://anonhg.NetBSD.org/

GNU Savannah projects (CVS/SVN/Git canonicals):
  Emacs (pre-2010 in bzr/cvs history is mirrored in tarballs and Savannah repos)
  Example (SVN/Git vary by project; check each project page):
    https://savannah.gnu.org/projects/

Sourceware (toolchain: binutils, glibc, GDB):
  https://sourceware.org/

Debian snapshots (exact historic source + patches):
  Browse: https://snapshot.debian.org/
  On Debian/Ubuntu:
    sudo apt-get update
    apt-get source <package>=<version>
  Example (select version via snapshot.debian.org and then):
    apt-get source postgresql-8.4=8.4.0-5

Software Heritage (SWHID-anchored snapshots; export tarballs of specific revisions):
  Start: https://archive.softwareheritage.org/
  You can export a directory tree at any known revision without GitHub/GitLab.
EOF

echo "Done. Review ${TARGET_DIR}"
